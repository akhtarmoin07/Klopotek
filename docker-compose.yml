services:
  # 1. ORACLE DATABASE
  oracle-db:
    # We use a lightweight, pre-built Oracle XE image.
    # Why? Official Oracle images are huge. This one is optimized for fast startup in demos.
    image: gvenzl/oracle-xe:21-slim-faststart
    container_name: klopotek-oracle
    environment:
      # These credentials are used by Liquibase and Exporter to connect later.
<<<<<<< HEAD
      # SECRETS: Injected by Ansible at runtime
      - ORACLE_PASSWORD=${ORACLE_PASSWORD}
      - APP_USER=${APP_USER}
      - APP_USER_PASSWORD=${APP_USER_PASSWORD}
=======
      - ORACLE_PASSWORD=KlopotekSecret123
      - APP_USER=stream_user
      - APP_USER_PASSWORD=stream_pass
>>>>>>> d709437a820e1bd3f5c7992afcf1add61a391c62
    ports:
      # Map container port 1521 to localhost:1521 so you can connect via SQLPlus.
      - "1521:1521"
    # PERSISTENCE: This is the key line for "Data Safety".
    # It tells Docker: "Save the database files in a named volume, not inside the container."
    # If the container dies, the data survives in 'oracle_data'.
    volumes:
      - oracle_data:/opt/oracle/oradata
    networks:
      # Connect to the shared network so other containers can talk to it by name.
      - klopotek-net
    # HEALTHCHECK: This prevents race conditions.
    # It actively runs a SQL query (`select 1 from dual`) to verify the DB is truly ready.
    healthcheck:
      test: ["CMD", "sqlplus", "-L", "stream_user/stream_pass@//localhost:1521/XEPDB1", "select 1 from dual"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # 2. LIQUIBASE (The Migration Runner)
  liquibase:
    # Instead of pulling an image, we BUILD one from the Dockerfile in the current directory.
    build: .
    container_name: klopotek-deployment-manager
    # SELF-HEALING: If this container crashes (e.g., connection refused), restart it automatically.
    restart: on-failure
    depends_on:
      # Don't even try to start until Oracle says it's "Healthy".
      oracle-db:
        condition: service_healthy
    networks:
      - klopotek-net
    volumes:
      # Mount the local changelog.sql into the container so Liquibase can read it.
      - ./changelog.sql:/liquibase/changelog.sql
    # Override entrypoint to allow us to run a custom shell script.
    entrypoint: /bin/bash
    # THE SMART WAIT SCRIPT:
    # This loop runs `liquibase validate` repeatedly.
    # It waits for the Oracle Listener AND the Database Service to be fully available.
    # Only then does it run the `update` command.
    command: >
      -c "
      echo 'Waiting for Oracle Database to be fully open...' &&
      for i in {1..60}; do
        if /liquibase/liquibase --url='jdbc:oracle:thin:@//oracle-db:1521/XEPDB1' \
             --username=${APP_USER} \
             --password=${APP_USER_PASSWORD} \
             --driver=oracle.jdbc.OracleDriver \
             validate > /dev/null 2>&1; then
           echo 'Database is UP! Starting migration...'
           break
        fi
        echo 'Database not ready yet... waiting 2s...'
        sleep 2
      done &&
      /liquibase/liquibase update \
      --url='jdbc:oracle:thin:@//oracle-db:1521/XEPDB1' \
      --username=stream_user \
      --password=stream_pass \
      --changelog-file=changelog.sql \
      --driver=oracle.jdbc.OracleDriver
      "

  # 3. ORACLE EXPORTER (The Bridge)
  oracle-exporter:
    # This tool queries Oracle and exposes metrics in a format Prometheus understands.
    image: iamseth/oracledb_exporter:latest
    container_name: klopotek-metrics-exporter
    environment:
<<<<<<< HEAD
      # SECRETS: Inject user/pass into connection string
      - DATA_SOURCE_NAME=${APP_USER}/${APP_USER_PASSWORD}@//oracle-db:1521/XEPDB1
=======
      # The connection string to talk to the database.
      - DATA_SOURCE_NAME=stream_user/stream_pass@//oracle-db:1521/XEPDB1
>>>>>>> d709437a820e1bd3f5c7992afcf1add61a391c62
    ports:
      - "9161:9161"
    networks:
      - klopotek-net
    depends_on:
      oracle-db:
        condition: service_healthy

  # 4. PROMETHEUS (The Collector)
  prometheus:
    image: prom/prometheus:latest
    container_name: klopotek-prometheus
    volumes:
      # Mount our custom config file so Prometheus knows what to scrape.
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - klopotek-net
    depends_on:
      - oracle-exporter

  # 5. GRAFANA (The Dashboard)
  grafana:
    image: grafana/grafana:latest
    container_name: klopotek-grafana
    ports:
      - "3000:3000"
    networks:
      - klopotek-net
    depends_on:
      - prometheus

networks:
  # Create a custom bridge network so containers can talk by name (DNS).
  klopotek-net:
    driver: bridge

volumes:
  # Define the named volume for persistence.
  oracle_data: